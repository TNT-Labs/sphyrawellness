// Sphyra Wellness Lab - PostgreSQL Schema
// Generated with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CUSTOMERS - Gestione clienti con consensi GDPR
// ============================================================================

model Customer {
  id          String   @id @default(uuid())
  firstName   String   @map("first_name") @db.VarChar(100)
  lastName    String   @map("last_name") @db.VarChar(100)
  email       String?  @unique @db.VarChar(255)
  phone       String?  @unique @db.VarChar(20)
  dateOfBirth DateTime? @map("date_of_birth") @db.Date
  notes       String?  @db.Text
  allergies   String?  @db.Text

  // GDPR Consents
  privacyConsent            Boolean   @default(false) @map("privacy_consent")
  privacyConsentDate        DateTime? @map("privacy_consent_date")
  privacyConsentVersion     String?   @map("privacy_consent_version") @db.VarChar(20)
  emailReminderConsent      Boolean   @default(false) @map("email_reminder_consent")
  emailReminderConsentDate  DateTime? @map("email_reminder_consent_date")
  smsReminderConsent        Boolean   @default(false) @map("sms_reminder_consent")
  smsReminderConsentDate    DateTime? @map("sms_reminder_consent_date")
  healthDataConsent         Boolean   @default(false) @map("health_data_consent")
  healthDataConsentDate     DateTime? @map("health_data_consent_date")
  marketingConsent          Boolean   @default(false) @map("marketing_consent")
  consentHistory            Json      @default("[]") @map("consent_history") // Array di ConsentHistoryEntry

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  appointments Appointment[]

  @@index([email])
  @@index([phone])
  @@index([createdAt])
  @@map("customers")
}

// ============================================================================
// SERVICE CATEGORIES - Categorie servizi
// ============================================================================

model ServiceCategory {
  id        String   @id @default(uuid())
  name      String   @unique @db.VarChar(100)
  color     String   @db.VarChar(7) // Hex color
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  services Service[]

  @@index([isActive])
  @@map("service_categories")
}

// ============================================================================
// SERVICES - Servizi offerti
// ============================================================================

model Service {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(200)
  description String?  @db.Text
  duration    Int      // minutes
  price       Decimal  @db.Decimal(10, 2)
  categoryId  String?  @map("category_id")
  color       String?  @db.VarChar(7)
  imageUrl    String?  @map("image_url") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  category     ServiceCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  appointments Appointment[]

  @@index([categoryId])
  @@index([name])
  @@map("services")
}

// ============================================================================
// STAFF ROLES - Ruoli staff
// ============================================================================

model StaffRole {
  id        String   @id @default(uuid())
  name      String   @unique @db.VarChar(100)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  staff Staff[]

  @@map("staff_roles")
}

// ============================================================================
// STAFF - Personale
// ============================================================================

model Staff {
  id              String   @id @default(uuid())
  firstName       String   @map("first_name") @db.VarChar(100)
  lastName        String   @map("last_name") @db.VarChar(100)
  email           String   @unique @db.VarChar(255)
  phone           String?  @db.VarChar(20)
  roleId          String?  @map("role_id")
  specializations String[] // Array di specializzazioni
  color           String   @db.VarChar(7) // Per calendario
  isActive        Boolean  @default(true) @map("is_active")
  profileImageUrl String?  @map("profile_image_url") @db.Text
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  role         StaffRole?    @relation(fields: [roleId], references: [id], onDelete: SetNull)
  appointments Appointment[]

  @@index([email])
  @@index([isActive])
  @@index([roleId])
  @@map("staff")
}

// ============================================================================
// APPOINTMENTS - Appuntamenti
// ============================================================================

enum AppointmentStatus {
  scheduled
  confirmed
  completed
  cancelled
  no_show

  @@map("appointment_status")
}

model Appointment {
  id         String            @id @default(uuid())
  customerId String            @map("customer_id")
  serviceId  String            @map("service_id")
  staffId    String            @map("staff_id")
  date       DateTime          @db.Date
  startTime  DateTime          @map("start_time") @db.Time
  endTime    DateTime          @map("end_time") @db.Time
  status     AppointmentStatus @default(scheduled)
  notes      String?           @db.Text

  // Reminder & Confirmation
  reminderSent           Boolean   @default(false) @map("reminder_sent")
  confirmationToken      String?   @unique @map("confirmation_token") @db.VarChar(255)
  confirmationTokenHash  String?   @map("confirmation_token_hash") @db.VarChar(255)
  tokenExpiresAt         DateTime? @map("token_expires_at")
  confirmedAt            DateTime? @map("confirmed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  customer  Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  service   Service    @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  staff     Staff      @relation(fields: [staffId], references: [id], onDelete: Restrict)
  payments  Payment[]
  reminders Reminder[]

  @@index([date, status])
  @@index([customerId, date])
  @@index([staffId, date])
  @@index([serviceId, status])
  @@index([confirmationToken])
  @@index([date])
  @@map("appointments")
}

// ============================================================================
// PAYMENTS - Pagamenti
// ============================================================================

enum PaymentMethod {
  cash
  card
  transfer
  other

  @@map("payment_method")
}

model Payment {
  id            String        @id @default(uuid())
  appointmentId String        @map("appointment_id")
  amount        Decimal       @db.Decimal(10, 2)
  method        PaymentMethod
  date          DateTime      @db.Date
  notes         String?       @db.Text
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([date])
  @@map("payments")
}

// ============================================================================
// REMINDERS - Promemoria
// ============================================================================

enum ReminderType {
  email
  sms
  whatsapp
  notification

  @@map("reminder_type")
}

model Reminder {
  id            String       @id @default(uuid())
  appointmentId String       @map("appointment_id")
  type          ReminderType
  scheduledFor  DateTime     @map("scheduled_for")
  sent          Boolean      @default(false)
  sentAt        DateTime?    @map("sent_at")
  errorMessage  String?      @map("error_message") @db.Text
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // Relations
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([sent, scheduledFor])
  @@map("reminders")
}

// ============================================================================
// USERS - Utenti sistema (autenticazione)
// ============================================================================

enum UserRole {
  RESPONSABILE
  UTENTE

  @@map("user_role")
}

model User {
  id           String    @id @default(uuid())
  username     String    @unique @db.VarChar(50)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  role         UserRole
  firstName    String    @map("first_name") @db.VarChar(100)
  lastName     String    @map("last_name") @db.VarChar(100)
  email        String?   @db.VarChar(255)
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@index([username])
  @@index([isActive])
  @@map("users")
}

// ============================================================================
// SETTINGS - Configurazioni applicazione
// ============================================================================

model Setting {
  id        String   @id @default(uuid())
  key       String   @unique @db.VarChar(100)
  value     Json     // Flexible JSON value
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by") // User ID che ha fatto l'update

  @@map("settings")
}
