# ========================================
# Sphyra Wellness Lab - HTTPS Rete Privata
# Self-Signed Certificates (NO Let's Encrypt)
# ========================================

services:
  # ========================================
  # TRAEFIK - Reverse Proxy (Self-Signed SSL)
  # ========================================
  traefik:
    image: traefik:v2.10
    container_name: sphyra-traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      # HTTP (will redirect to HTTPS)
      - "80:80"
      # HTTPS
      - "443:443"
      # Dashboard (optional)
      - "8080:8080"
    volumes:
      # Docker socket (read-only)
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Traefik configuration
      - ./traefik/traefik-private.yml:/traefik.yml:ro
      - ./traefik/dynamic:/dynamic:ro
      # Self-signed certificates
      - ./traefik/certs:/certs:ro
      # Logs
      - traefik_logs:/logs
    networks:
      - sphyra-network
      - traefik-public
    command:
      # Static configuration via file
      - --configFile=/traefik.yml
    labels:
      - "traefik.enable=true"
      # Dashboard
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.${PRIVATE_DOMAIN:-sphyra.local}`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ========================================
  # DATABASE - CouchDB (INTERNO)
  # ========================================
  couchdb:
    image: apache/couchdb:latest
    container_name: sphyra-couchdb
    restart: unless-stopped
    environment:
      - COUCHDB_USER=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
    volumes:
      - couchdb_data:/opt/couchdb/data
      - couchdb_config:/opt/couchdb/etc/local.d
    networks:
      - sphyra-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/_up"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    labels:
      - "traefik.enable=false"

  # ========================================
  # BACKEND - API Server (HTTPS)
  # ========================================
  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: sphyra-backend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3001
      # JWT Secret for authentication
      - JWT_SECRET=${JWT_SECRET}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - SENDGRID_FROM_EMAIL=${SENDGRID_FROM_EMAIL:-noreply@sphyrawellness.com}
      - SENDGRID_FROM_NAME=${SENDGRID_FROM_NAME:-Sphyra Wellness Lab}
      # Frontend URL (HTTPS local)
      - FRONTEND_URL=https://${PRIVATE_DOMAIN:-sphyra.local}
      # CouchDB (internal)
      - COUCHDB_URL=http://couchdb:5984
      - COUCHDB_USERNAME=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      - REMINDER_SEND_HOUR=${REMINDER_SEND_HOUR:-10}
      - REMINDER_SEND_MINUTE=${REMINDER_SEND_MINUTE:-0}
    depends_on:
      couchdb:
        condition: service_healthy
    networks:
      - sphyra-network
      - traefik-public
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # HTTP Router (redirect to HTTPS)
      - "traefik.http.routers.backend-http.rule=Host(`${PRIVATE_DOMAIN:-sphyra.local}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.backend-http.entrypoints=web"
      - "traefik.http.routers.backend-http.middlewares=redirect-to-https@file"

      # HTTPS Router
      - "traefik.http.routers.backend.rule=Host(`${PRIVATE_DOMAIN:-sphyra.local}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls=true"
      - "traefik.http.routers.backend.middlewares=security-headers@file"
      - "traefik.http.services.backend.loadbalancer.server.port=3001"

  # ========================================
  # FRONTEND - PWA (HTTPS)
  # ========================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.https
      args:
        - VITE_API_URL=https://${PRIVATE_DOMAIN:-sphyra.local}/api
    container_name: sphyra-frontend
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      - traefik-public
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # HTTP Router (redirect to HTTPS)
      - "traefik.http.routers.frontend-http.rule=Host(`${PRIVATE_DOMAIN:-sphyra.local}`)"
      - "traefik.http.routers.frontend-http.entrypoints=web"
      - "traefik.http.routers.frontend-http.middlewares=redirect-to-https@file"

      # HTTPS Router
      - "traefik.http.routers.frontend.rule=Host(`${PRIVATE_DOMAIN:-sphyra.local}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.routers.frontend.middlewares=security-headers@file"
      - "traefik.http.routers.frontend.priority=1"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"

# ========================================
# NETWORKS
# ========================================
networks:
  sphyra-network:
    driver: bridge
    internal: true

  traefik-public:
    driver: bridge

# ========================================
# VOLUMES
# ========================================
volumes:
  couchdb_data:
    driver: local
  couchdb_config:
    driver: local
  traefik_logs:
    driver: local
