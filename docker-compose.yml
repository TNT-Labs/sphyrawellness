services:
  # Database CouchDB
  couchdb:
    image: apache/couchdb:latest
    container_name: sphyra-couchdb
    restart: unless-stopped
    ports:
      - "5984:5984"
    environment:
      - COUCHDB_USER=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
    volumes:
      - couchdb_data:/opt/couchdb/data
      - couchdb_config:/opt/couchdb/etc/local.d
    networks:
      - sphyra-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/_up"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Backend API Server
  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: sphyra-backend
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      # SendGrid Configuration (MODIFICARE CON I PROPRI VALORI)
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - SENDGRID_FROM_EMAIL=${SENDGRID_FROM_EMAIL:-noreply@sphyrawellness.com}
      - SENDGRID_FROM_NAME=${SENDGRID_FROM_NAME:-Sphyra Wellness}
      # Frontend URL
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost}
      # CouchDB Configuration
      - COUCHDB_URL=http://couchdb:5984
      - COUCHDB_USERNAME=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      # Reminder Configuration
      - REMINDER_SEND_HOUR=${REMINDER_SEND_HOUR:-10}
      - REMINDER_SEND_MINUTE=${REMINDER_SEND_MINUTE:-0}
    depends_on:
      couchdb:
        condition: service_healthy
    networks:
      - sphyra-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend PWA (Nginx)
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL:-http://localhost:3001/api}
    container_name: sphyra-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - sphyra-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  sphyra-network:
    driver: bridge

volumes:
  couchdb_data:
    driver: local
  couchdb_config:
    driver: local
