# ========================================
# Sphyra Wellness Lab - HTTPS con Let's Encrypt
# Certificati SSL/TLS validi e fidati
# ========================================

services:
  # ========================================
  # NGINX - Reverse Proxy (Let's Encrypt SSL)
  # ========================================
  nginx:
    image: nginx:alpine
    container_name: sphyra-nginx
    restart: unless-stopped
    ports:
      # HTTP (necessario per ACME challenge + redirect HTTPS)
      - "80:80"
      # HTTPS
      - "443:443"
    volumes:
      # Nginx configuration
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d/sphyra-letsencrypt.conf:/etc/nginx/conf.d/default.conf:ro
      # Let's Encrypt certificates
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
      # Logs
      - nginx_logs:/var/log/nginx
    networks:
      - sphyra-network
    depends_on:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    environment:
      # Dominio per la configurazione Nginx
      - DOMAIN=${DOMAIN}
    command: >
      /bin/sh -c "envsubst '$${DOMAIN}' < /etc/nginx/conf.d/default.conf > /etc/nginx/conf.d/sphyra.conf
      && rm /etc/nginx/conf.d/default.conf
      && while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g 'daemon off;'"

  # ========================================
  # CERTBOT - Let's Encrypt Client
  # ========================================
  certbot:
    image: certbot/certbot
    container_name: sphyra-certbot
    restart: unless-stopped
    volumes:
      # Let's Encrypt configuration e certificati
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    networks:
      - sphyra-network
    # Rinnovo automatico ogni 12 ore
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot --webroot-path=/var/www/certbot --quiet; sleep 12h & wait $${!}; done;'"

  # ========================================
  # DATABASE - CouchDB (INTERNO)
  # ========================================
  couchdb:
    image: apache/couchdb:latest
    container_name: sphyra-couchdb
    restart: unless-stopped
    ports:
      # Expose CouchDB port for local development/configuration
      - "5984:5984"
    environment:
      - COUCHDB_USER=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
    volumes:
      - couchdb_data:/opt/couchdb/data
      - couchdb_config:/opt/couchdb/etc/local.d
    networks:
      - sphyra-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/_up"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    labels:
      - "traefik.enable=false"

  # ========================================
  # BACKEND - API Server (HTTPS)
  # ========================================
  backend:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: sphyra-backend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3001
      # JWT Secret for authentication
      - JWT_SECRET=${JWT_SECRET}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - SENDGRID_FROM_EMAIL=${SENDGRID_FROM_EMAIL:-noreply@sphyrawellness.com}
      - SENDGRID_FROM_NAME=${SENDGRID_FROM_NAME:-Sphyra Wellness Lab}
      # Frontend URL (HTTPS public domain)
      - FRONTEND_URL=https://${DOMAIN}
      # CouchDB (internal)
      - COUCHDB_URL=http://couchdb:5984
      - COUCHDB_USERNAME=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      - REMINDER_SEND_HOUR=${REMINDER_SEND_HOUR:-10}
      - REMINDER_SEND_MINUTE=${REMINDER_SEND_MINUTE:-0}
      # CORS - Permetti il dominio pubblico
      - ALLOWED_ORIGINS=https://${DOMAIN}
    depends_on:
      couchdb:
        condition: service_healthy
    networks:
      - sphyra-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ========================================
  # FRONTEND - PWA (HTTPS)
  # ========================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.https
      args:
        - VITE_API_URL=/api
    container_name: sphyra-frontend
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      - sphyra-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ========================================
# NETWORKS
# ========================================
networks:
  sphyra-network:
    driver: bridge

# ========================================
# VOLUMES
# ========================================
volumes:
  couchdb_data:
    driver: local
  couchdb_config:
    driver: local
  nginx_logs:
    driver: local
