# ========================================
# Sphyra Wellness Lab - Cloudflare Quick Tunnel
# HTTPS automatico con URL .trycloudflare.com
# NESSUNA configurazione DNS richiesta!
# ========================================

services:
  # ========================================
  # CLOUDFLARE QUICK TUNNEL
  # ========================================
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: sphyra-quicktunnel
    restart: unless-stopped
    command: tunnel --url http://nginx:80
    networks:
      - sphyra-network
    depends_on:
      - nginx
    # Il tunnel stamperÃ  l'URL pubblico nei log!
    # Usa: docker logs sphyra-quicktunnel per vederlo

  # ========================================
  # NGINX - Reverse Proxy
  # ========================================
  nginx:
    image: nginx:alpine
    container_name: sphyra-nginx
    restart: unless-stopped
    volumes:
      # Nginx configuration
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d/sphyra-quicktunnel.conf:/etc/nginx/conf.d/default.conf:ro
      # Logs
      - nginx_logs:/var/log/nginx
    networks:
      - sphyra-network
    depends_on:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ========================================
  # DATABASE - CouchDB
  # ========================================
  couchdb:
    image: apache/couchdb:latest
    container_name: sphyra-couchdb
    restart: unless-stopped
    ports:
      # Expose CouchDB port for local development/configuration
      - "5984:5984"
    environment:
      - COUCHDB_USER=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
    volumes:
      - couchdb_data:/opt/couchdb/data
      - couchdb_config:/opt/couchdb/etc/local.d
    networks:
      - sphyra-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/_up"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # ========================================
  # BACKEND - API Server
  # ========================================
  backend:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: sphyra-backend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3001
      # JWT Secret for authentication
      - JWT_SECRET=${JWT_SECRET}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - SENDGRID_FROM_EMAIL=${SENDGRID_FROM_EMAIL:-noreply@sphyrawellness.com}
      - SENDGRID_FROM_NAME=${SENDGRID_FROM_NAME:-Sphyra Wellness Lab}
      # CouchDB (internal)
      - COUCHDB_URL=http://couchdb:5984
      - COUCHDB_USERNAME=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      - REMINDER_SEND_HOUR=${REMINDER_SEND_HOUR:-10}
      - REMINDER_SEND_MINUTE=${REMINDER_SEND_MINUTE:-0}
      # CORS - Permetti tutti gli origin (quick tunnel genera URL casuali)
      - ALLOWED_ORIGINS=*
    depends_on:
      couchdb:
        condition: service_healthy
    networks:
      - sphyra-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ========================================
  # FRONTEND - PWA
  # ========================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.https
      args:
        - VITE_API_URL=/api
    container_name: sphyra-frontend
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      - sphyra-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ========================================
# NETWORKS
# ========================================
networks:
  sphyra-network:
    driver: bridge

# ========================================
# VOLUMES
# ========================================
volumes:
  couchdb_data:
    driver: local
  couchdb_config:
    driver: local
  nginx_logs:
    driver: local
