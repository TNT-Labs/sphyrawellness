================================================================================
  CHECKLIST DI VALIDAZIONE - SPHYRA WELLNESS LAB PWA
================================================================================

Data: 2025-12-11
Progetto: Sphyra Wellness Lab v1.0.0
Branch: claude/technical-audit-012UcKWbjvwhzpUrZyf4bwqJ

================================================================================
  PASSAGGI PER VALIDARE LE CORREZIONI
================================================================================

Questa checklist fornisce istruzioni chiare e verificabili per validare
le correzioni dei 5 problemi principali identificati nell'audit tecnico.

Ogni passaggio include:
- Comandi esatti da eseguire
- Output atteso
- Criteri di successo

--------------------------------------------------------------------------------
ISSUE-001: FIX JWT_SECRET HARDCODED (CRITICAL)
--------------------------------------------------------------------------------

Priorità: IMMEDIATA
Effort: 1 punto (< 1 ora)

[ ] 1. Applicare la patch

    # Salvare il diff in un file
    cat > /tmp/fix-jwt.patch << 'EOF'
    --- a/server/src/middleware/auth.ts
    +++ b/server/src/middleware/auth.ts
    @@ -3,7 +3,14 @@
     import jwt from 'jsonwebtoken';
     import { Request, Response, NextFunction } from 'express';

    -const JWT_SECRET = process.env.JWT_SECRET || 'CHANGE-THIS-IN-PRODUCTION-USE-ENV-VAR';
    +const JWT_SECRET = process.env.JWT_SECRET;
    +
    +if (!JWT_SECRET) {
    +  console.error('❌ FATAL: JWT_SECRET environment variable is not set!');
    +  console.error('   Please add JWT_SECRET to your .env file with a secure random value.');
    +  console.error('   Example: JWT_SECRET=$(openssl rand -base64 32)');
    +  process.exit(1);
    +}

     export interface AuthRequest extends Request {
       user?: {
    EOF

    # Applicare la patch
    git apply /tmp/fix-jwt.patch

    ✅ Successo: File server/src/middleware/auth.ts modificato

[ ] 2. Aggiornare .env.example

    # Aggiungere JWT_SECRET a server/.env.example
    echo "" >> server/.env.example
    echo "# JWT Secret (required)" >> server/.env.example
    echo "# Generate with: openssl rand -base64 32" >> server/.env.example
    echo "JWT_SECRET=your_jwt_secret_here" >> server/.env.example

    ✅ Successo: server/.env.example contiene JWT_SECRET

[ ] 3. Rebuild backend

    cd server
    npm run build

    ✅ Successo: Build completa senza errori
    ✅ File dist/middleware/auth.js esiste

[ ] 4. Test che il server fallisce senza JWT_SECRET

    # Rimuovere JWT_SECRET da .env (se esiste)
    cd server
    unset JWT_SECRET
    npm start

    ✅ Output atteso:
    ❌ FATAL: JWT_SECRET environment variable is not set!
       Please add JWT_SECRET to your .env file with a secure random value.
       Example: JWT_SECRET=$(openssl rand -base64 32)

    ✅ Exit code: 1 (processo termina)

[ ] 5. Test con JWT_SECRET configurato

    # Generare JWT_SECRET sicuro
    export JWT_SECRET=$(openssl rand -base64 32)

    # Oppure aggiungi a .env
    echo "JWT_SECRET=$(openssl rand -base64 32)" >> server/.env

    # Avviare server
    npm start

    ✅ Output atteso: Server avvia correttamente
    ✅ Nessun errore relativo a JWT_SECRET

[ ] 6. Commit e documentazione

    git add server/src/middleware/auth.ts server/.env.example
    git commit -m "fix(security): Remove insecure JWT_SECRET fallback [ISSUE-001]"

    ✅ Successo: Commit creato

VALIDAZIONE COMPLETA: ✅ ISSUE-001 risolto

--------------------------------------------------------------------------------
ISSUE-002: DIPENDENZE DEPRECATE (HIGH)
--------------------------------------------------------------------------------

Priorità: ALTA (breve termine)
Effort: 5 punti (1-2 giorni)

[ ] 1. Verificare versione corrente pouchdb-node

    npm list pouchdb-node

    ✅ Output: pouchdb-node@9.0.0 (o versione installata)

[ ] 2. Controllare se esistono aggiornamenti

    npm outdated pouchdb-node

    ✅ Se esiste versione più recente, annotare numero

[ ] 3. Controllare changelog/release notes

    # Visitare:
    https://github.com/pouchdb/pouchdb/releases

    # Cercare riferimenti a:
    - abstract-level
    - classic-level
    - Fix per package deprecati

    ✅ Documentare se esistono versioni aggiornate

[ ] 4. Se NON esistono aggiornamenti pouchdb-node

    # Opzione A: Accettare il rischio a breve termine
    # Creare issue di tracking

    # Opzione B: Valutare alternative a pouchdb-node
    # Considerare:
    # - rxdb
    # - WatermelonDB
    # - Direct CouchDB client

    ✅ Decisione documentata e comunicata al team

[ ] 5. Monitorare security advisories

    # Aggiungere a CI/CD un check periodico
    npm audit --audit-level=moderate

    # Configurare Dependabot o Renovate Bot per auto-updates

    ✅ Monitoring configurato

VALIDAZIONE COMPLETA: ✅ ISSUE-002 sotto controllo

--------------------------------------------------------------------------------
ISSUE-003: DYNAMIC IMPORT WARNING (MEDIUM)
--------------------------------------------------------------------------------

Priorità: MEDIA (breve termine)
Effort: 2 punti (2-4 ore)

[ ] 1. Analizzare utilizzo di api.ts

    # Cercare import dinamici
    grep -r "import.*api" src/contexts/AppContext.tsx

    # Cercare import statici
    grep -r "import.*api" src/components/settings/ReminderSettingsCard.tsx
    grep -r "import.*api" src/pages/ConfirmAppointment.tsx
    grep -r "import.*api" src/pages/Reminders.tsx

    ✅ Mappatura completa degli import

[ ] 2. Scegliere strategia

    Opzione A: Rimuovere dynamic import (se non necessario)
    Opzione B: Usare solo dynamic import (lazy loading)
    Opzione C: Splittare api.ts in moduli più piccoli

    ✅ Strategia scelta e documentata

[ ] 3. Applicare fix

    # Esempio Opzione A: Rimuovere dynamic import
    # Modificare src/contexts/AppContext.tsx
    # Cambiare da: const api = await import('./utils/api')
    # A: import { ... } from './utils/api'

    ✅ Modifiche applicate

[ ] 4. Rebuild e verificare warning

    npm run build 2>&1 | grep "dynamically imported"

    ✅ Output atteso: Nessun warning

[ ] 5. Verificare bundle size

    npm run build

    # Confrontare dimensioni
    ls -lh dist/assets/*.js

    ✅ Bundle size ottimizzato o invariato

VALIDAZIONE COMPLETA: ✅ ISSUE-003 risolto

--------------------------------------------------------------------------------
ISSUE-004: TEST BACKEND NON IMPLEMENTATI (MEDIUM)
--------------------------------------------------------------------------------

Priorità: ALTA (implementazione graduale)
Effort: 8 punti (3-5 giorni)

[ ] 1. Setup framework di testing

    cd server
    npm install -D vitest @vitest/ui
    npm install -D @types/node

    ✅ Dipendenze installate

[ ] 2. Creare configurazione vitest

    # Creare vitest.config.ts
    cat > vitest.config.ts << 'EOF'
    import { defineConfig } from 'vitest/config';

    export default defineConfig({
      test: {
        globals: true,
        environment: 'node',
        coverage: {
          provider: 'v8',
          reporter: ['text', 'json', 'html'],
          exclude: ['node_modules/', 'dist/', '**/*.test.ts']
        }
      }
    });
    EOF

    ✅ vitest.config.ts creato

[ ] 3. Implementare test per emailService

    mkdir -p src/__tests__/services

    # Creare src/__tests__/services/emailService.test.ts
    # Test da implementare:
    # - Formattazione email corretta
    # - Gestione errori SendGrid
    # - Template rendering

    ✅ Test emailService implementati

[ ] 4. Implementare test per reminderService

    # Creare src/__tests__/services/reminderService.test.ts
    # Test da implementare:
    # - Creazione reminder
    # - Generazione token sicuri
    # - Scadenza token
    # - Invio reminder

    ✅ Test reminderService implementati

[ ] 5. Implementare test per auth middleware

    # Creare src/__tests__/middleware/auth.test.ts
    # Test da implementare:
    # - Verifica token valido
    # - Reiezione token invalido
    # - Gestione token mancante
    # - Verifica JWT_SECRET obbligatorio

    ✅ Test auth implementati

[ ] 6. Implementare test API endpoints

    # Creare src/__tests__/routes/reminders.test.ts
    # Test da implementare:
    # - GET /api/reminders/appointments-needing-reminders
    # - POST /api/reminders/send/:id
    # - POST /api/reminders/send-all

    ✅ Test routes implementati

[ ] 7. Eseguire test e verificare coverage

    npm test
    npm run test:coverage

    ✅ Output atteso: Tutti i test passano
    ✅ Coverage > 70%

[ ] 8. Aggiornare package.json

    # Modificare script test
    {
      "scripts": {
        "test": "vitest",
        "test:run": "vitest run",
        "test:coverage": "vitest run --coverage"
      }
    }

    ✅ package.json aggiornato

[ ] 9. Aggiornare CI/CD

    # Aggiungere a .github/workflows/deploy.yml
    # Nel job backend-quality:

    - name: Run Tests (backend)
      run: npm run test:run

    - name: Check Coverage
      run: npm run test:coverage

    ✅ CI/CD aggiornato

VALIDAZIONE COMPLETA: ✅ ISSUE-004 risolto

--------------------------------------------------------------------------------
ISSUE-005: LINT WARNINGS FILE GENERATI (LOW)
--------------------------------------------------------------------------------

Priorità: BASSA
Effort: 1 punto (15 minuti)

[ ] 1. Creare .eslintignore

    cd server
    cat > .eslintignore << 'EOF'
    dist/
    node_modules/
    EOF

    ✅ .eslintignore creato

[ ] 2. Verificare lint

    npm run lint

    ✅ Output atteso: 0 warnings, 0 errors

[ ] 3. Commit

    git add .eslintignore
    git commit -m "chore: Exclude dist/ from ESLint [ISSUE-005]"

    ✅ Commit creato

VALIDAZIONE COMPLETA: ✅ ISSUE-005 risolto

================================================================================
  CHECKLIST PRE-PRODUZIONE (COMPLETA)
================================================================================

Prima del deployment in produzione, verificare TUTTI i seguenti punti:

SICUREZZA
---------
[ ] JWT_SECRET impostato con valore sicuro (min 32 caratteri random)
[ ] SENDGRID_API_KEY configurato con key valida
[ ] COUCHDB_PASSWORD cambiata da default
[ ] Nessun segreto nel codice sorgente
[ ] HTTPS abilitato per tutte le comunicazioni
[ ] CORS configurato con origins specifici (non *)
[ ] Helmet configurato per security headers
[ ] Rate limiting configurato

BACKEND
-------
[ ] Test backend implementati (coverage >70%)
[ ] .env con tutte le variabili richieste
[ ] CouchDB accessibile e configurato
[ ] SendGrid sender identity verificata
[ ] Logging configurato e testato
[ ] Error handling testato
[ ] Healthcheck endpoint funzionante

FRONTEND
--------
[ ] Build produzione completata senza errori
[ ] Lint strict passa (0 warnings)
[ ] Tutti i test passano (32/32)
[ ] PWA manifest generato correttamente
[ ] Service worker registrato
[ ] Offline mode testato
[ ] Performance Lighthouse >90

DEVOPS
------
[ ] CI/CD pipeline passa tutti i check
[ ] Docker images buildate correttamente
[ ] Healthchecks funzionanti
[ ] Backup CouchDB configurato
[ ] Monitoring/alerting configurato
[ ] Log rotation configurata

================================================================================
  CONTATTI
================================================================================

Per domande o chiarimenti sull'audit:
- Report dettagliato: audit-output/report.md
- Report JSON: audit-output/report.json
- Artifacts: audit-output/artifacts/
- Comandi eseguiti: audit-output/artifacts/commands/

================================================================================
  FINE CHECKLIST
================================================================================
