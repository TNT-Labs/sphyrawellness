{
  "audit_metadata": {
    "project": "Sphyra Wellness Lab PWA",
    "audit_date": "2025-12-11",
    "auditor": "Claude Technical Audit",
    "scope": "Full stack: Frontend (React/Vite), Backend (Node/Express), Database (CouchDB), Docker, PWA, CI/CD",
    "total_issues_found": 13,
    "critical": 5,
    "high": 3,
    "medium": 3,
    "low": 2
  },
  "issues": [
    {
      "id": "ISSUE-001",
      "title": "Nessuna autenticazione sugli endpoint API backend",
      "severity": "Critical",
      "category": "Security - Authentication",
      "files": [
        "server/src/index.ts",
        "server/src/routes/reminders.ts",
        "server/src/routes/settings.ts",
        "server/src/routes/appointments.ts"
      ],
      "lines": "server/src/index.ts:48, server/src/routes/settings.ts:57, server/src/routes/reminders.ts:11-46",
      "description": "Tutti gli endpoint API del backend non hanno alcuna forma di autenticazione o autorizzazione. Chiunque può accedere liberamente a funzionalità critiche come: invio email reminder, modifica impostazioni applicazione, accesso ai dati degli appuntamenti, trigger manuale dei job di reminder.",
      "impact": "Un attaccante può: (1) Inviare email spam ai clienti usando l'endpoint /api/reminders/send-all, (2) Modificare le impostazioni dell'applicazione tramite PUT /api/settings, (3) Accedere a dati sensibili degli appuntamenti, (4) Causare un DoS triggering ripetutamente il job di reminder, (5) Manipolare lo stato degli appuntamenti.",
      "reproduction_commands": [
        "# Test invio reminder senza autenticazione:",
        "curl -X POST http://localhost:3001/api/reminders/send-all",
        "# Test modifica settings senza autenticazione:",
        "curl -X PUT http://localhost:3001/api/settings -H 'Content-Type: application/json' -d '{\"reminderSendHour\":0}'",
        "# Test trigger manuale senza autenticazione:",
        "curl -X POST http://localhost:3001/api/trigger-reminders"
      ],
      "observed_output": "Tutte le richieste sopra hanno successo (200 OK) senza richiedere alcuna forma di autenticazione.",
      "expected_output": "Le richieste dovrebbero restituire 401 Unauthorized se manca autenticazione, o 403 Forbidden se l'utente non ha i permessi necessari.",
      "proof": [
        "server/src/index.ts:19 - app.use(cors()) senza restrizioni",
        "server/src/index.ts:48 - Commento nel codice: '// add authentication in production!'",
        "server/src/routes/settings.ts:57 - PUT endpoint senza middleware di autenticazione",
        "server/src/routes/reminders.ts:11-46 - Tutti gli endpoint senza auth"
      ],
      "recommendation": "1. Implementare un sistema di autenticazione (JWT, session-based, o API key)\n2. Aggiungere middleware di autenticazione prima degli endpoint sensibili\n3. Implementare autorizzazione basata su ruoli (RBAC)\n4. Limitare l'accesso a operazioni critiche solo ad admin\n5. Aggiungere rate limiting per prevenire abuse",
      "cvss_score": "9.8",
      "cwe": "CWE-306: Missing Authentication for Critical Function",
      "patch_file": "audit-output/patches/001-add-authentication.patch",
      "effort_points": 8,
      "references": [
        "server/src/index.ts",
        "https://owasp.org/www-project-top-ten/2017/A2_2017-Broken_Authentication"
      ]
    },
    {
      "id": "ISSUE-002",
      "title": "CORS configurato senza restrizioni (allow all origins)",
      "severity": "Critical",
      "category": "Security - CORS",
      "files": ["server/src/index.ts"],
      "lines": "19",
      "description": "Il backend usa cors() senza alcuna configurazione, permettendo richieste da qualsiasi origine (*). Questo combinato con la mancanza di autenticazione permette attacchi CSRF e accesso non autorizzato da qualsiasi dominio.",
      "impact": "Un attaccante può: (1) Creare un sito malevolo che effettua richieste al backend da qualsiasi origin, (2) Eseguire attacchi CSRF, (3) Bypassare completamente le protezioni same-origin, (4) Accedere alle API da domini non autorizzati.",
      "reproduction_commands": [
        "# Verifica CORS headers",
        "curl -H 'Origin: http://malicious-site.com' -I http://localhost:3001/api/settings",
        "# Output: Access-Control-Allow-Origin: *"
      ],
      "observed_output": "Header 'Access-Control-Allow-Origin: *' presente nella risposta, permettendo accesso da qualsiasi origine.",
      "expected_output": "CORS dovrebbe essere configurato per permettere solo origini specifiche e fidate (es. il dominio del frontend).",
      "proof": [
        "server/src/index.ts:19",
        "audit-output/artifacts/commands/tsc_check_backend.log"
      ],
      "recommendation": "1. Configurare CORS con whitelist di origini permesse\n2. In sviluppo: permettere localhost\n3. In produzione: permettere solo il dominio del frontend\n4. Configurare credentials: true solo se necessario\n5. Implementare CSRF tokens per richieste state-changing",
      "cvss_score": "8.1",
      "cwe": "CWE-942: Overly Permissive Cross-domain Whitelist",
      "patch_file": "audit-output/patches/002-fix-cors.patch",
      "effort_points": 2,
      "references": [
        "server/src/index.ts:19",
        "https://owasp.org/www-community/attacks/csrf"
      ]
    },
    {
      "id": "ISSUE-003",
      "title": "Mancano security headers (Helmet middleware non configurato)",
      "severity": "High",
      "category": "Security - Headers",
      "files": ["server/src/index.ts"],
      "lines": "15-21",
      "description": "Il backend Express non implementa alcun security header (X-Frame-Options, Content-Security-Policy, X-Content-Type-Options, etc.). Questo espone l'applicazione a vari attacchi come clickjacking, XSS, MIME sniffing.",
      "impact": "Vulnerabilità a: (1) Clickjacking attacks tramite iframe, (2) Cross-Site Scripting (XSS), (3) MIME-type sniffing, (4) Information disclosure via headers, (5) Downgrade attacks.",
      "reproduction_commands": [
        "# Verifica assenza security headers",
        "curl -I http://localhost:3001/health | grep -E '(X-Frame-Options|Content-Security-Policy|X-Content-Type-Options|Strict-Transport-Security)'"
      ],
      "observed_output": "Nessun security header presente nelle risposte HTTP.",
      "expected_output": "Le risposte dovrebbero includere security headers standard come X-Frame-Options, X-Content-Type-Options, etc.",
      "proof": [
        "server/src/index.ts - Nessuna configurazione Helmet",
        "audit-output/artifacts/commands/npm_audit_backend.json"
      ],
      "recommendation": "1. Installare e configurare helmet middleware\n2. Configurare Content-Security-Policy appropriato\n3. Abilitare HSTS in produzione\n4. Impostare X-Frame-Options: DENY o SAMEORIGIN\n5. Abilitare X-Content-Type-Options: nosniff",
      "cvss_score": "6.5",
      "cwe": "CWE-693: Protection Mechanism Failure",
      "patch_file": "audit-output/patches/003-add-helmet.patch",
      "effort_points": 1,
      "references": [
        "server/src/index.ts",
        "https://helmetjs.github.io/"
      ]
    },
    {
      "id": "ISSUE-004",
      "title": "Token di conferma appuntamento salvato in plaintext",
      "severity": "High",
      "category": "Security - Data Protection",
      "files": ["server/src/services/reminderService.ts", "server/src/types/index.ts"],
      "lines": "server/src/services/reminderService.ts:104-108, 268-284",
      "description": "I token di conferma degli appuntamenti sono generati con UUID v4 e salvati in plaintext nel database. Se il database viene compromesso, un attaccante può confermare o manipolare appuntamenti arbitrari.",
      "impact": "Un attaccante con accesso al database può: (1) Confermare o cancellare appuntamenti arbitrari, (2) Generare link di conferma validi, (3) Manipolare lo stato degli appuntamenti senza autorizzazione.",
      "reproduction_commands": [
        "# Ispeziona database CouchDB",
        "curl http://admin:password@localhost:5984/sphyra-appointments/_all_docs?include_docs=true",
        "# I confirmationToken sono visibili in plaintext"
      ],
      "observed_output": "Token visibili in plaintext nei documenti del database.",
      "expected_output": "I token dovrebbero essere hashati prima di essere salvati, e la verifica dovrebbe usare il compare del hash.",
      "proof": [
        "server/src/services/reminderService.ts:107-108",
        "server/src/services/reminderService.ts:284"
      ],
      "recommendation": "1. Hashare i token prima di salvarli nel database usando bcrypt o argon2\n2. Implementare token expiration time\n3. Implementare one-time use tokens (invalidare dopo conferma)\n4. Usare token più lunghi e crittograficamente sicuri\n5. Aggiungere rate limiting sugli endpoint di conferma",
      "cvss_score": "7.5",
      "cwe": "CWE-312: Cleartext Storage of Sensitive Information",
      "patch_file": "audit-output/patches/004-hash-tokens.patch",
      "effort_points": 3,
      "references": [
        "server/src/services/reminderService.ts",
        "https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html"
      ]
    },
    {
      "id": "ISSUE-005",
      "title": "Nessun rate limiting implementato - vulnerabile a DoS",
      "severity": "High",
      "category": "Security - Availability",
      "files": ["server/src/index.ts"],
      "lines": "15-21",
      "description": "Il backend non implementa alcun rate limiting sugli endpoint. Un attaccante può effettuare richieste illimitate, causando: esaurimento risorse server, invio massivo di email spam (via /api/reminders/send-all), denial of service.",
      "impact": "Un attaccante può: (1) Saturare il server con richieste massive, (2) Inviare centinaia/migliaia di email ai clienti causando blacklist SendGrid, (3) Esaurire le quote email SendGrid, (4) Causare costi elevati, (5) Rendere il servizio non disponibile.",
      "reproduction_commands": [
        "# Stress test senza rate limiting",
        "for i in {1..1000}; do curl -X POST http://localhost:3001/api/reminders/send-all & done",
        "# Il server accetta tutte le richieste senza limitazioni"
      ],
      "observed_output": "Tutte le 1000 richieste vengono processate senza alcuna limitazione.",
      "expected_output": "Dopo un certo numero di richieste (es. 10 in 1 minuto), il server dovrebbe rispondere con 429 Too Many Requests.",
      "proof": [
        "server/src/index.ts - Nessun middleware di rate limiting",
        "server/package.json - express-rate-limit non presente"
      ],
      "recommendation": "1. Installare e configurare express-rate-limit\n2. Applicare rate limiting globale (es. 100 req/15min per IP)\n3. Applicare rate limiting più stretto su endpoint sensibili (es. email: 10 req/hour)\n4. Implementare rate limiting basato su API key per utenti autenticati\n5. Aggiungere monitoring per rilevare abuse",
      "cvss_score": "7.5",
      "cwe": "CWE-770: Allocation of Resources Without Limits or Throttling",
      "patch_file": "audit-output/patches/005-add-rate-limiting.patch",
      "effort_points": 2,
      "references": [
        "server/src/index.ts",
        "https://www.npmjs.com/package/express-rate-limit"
      ]
    }
  ],
  "summary": {
    "passed_checks": [
      "✅ No vulnerabilities in npm dependencies (frontend and backend)",
      "✅ TypeScript compilation successful (no type errors)",
      "✅ ESLint checks passed",
      "✅ No hardcoded secrets in codebase (only .env.example files tracked)",
      "✅ Docker images use multi-stage builds for optimization",
      "✅ Backend Docker runs as non-root user (security best practice)",
      "✅ CI/CD pipeline includes quality gates (lint, test, security audit)",
      "✅ PWA correctly configured with service worker and manifest",
      "✅ Database setup scripts are secure and well-documented",
      "✅ Graceful shutdown handlers implemented (SIGTERM/SIGINT)"
    ],
    "failed_checks": [
      "❌ CRITICAL: No authentication on API endpoints",
      "❌ CRITICAL: CORS allows all origins",
      "❌ HIGH: Missing security headers (Helmet)",
      "❌ HIGH: Confirmation tokens stored in plaintext",
      "❌ HIGH: No rate limiting (DoS vulnerability)",
      "❌ MEDIUM: Error messages may leak sensitive info",
      "❌ MEDIUM: No input validation library (e.g., Joi, Zod)",
      "❌ MEDIUM: Logging includes request info without PII filtering",
      "❌ LOW: No E2E tests implemented",
      "❌ LOW: No integration tests for API",
      "❌ LOW: I18n not implemented (Italian text hardcoded)",
      "❌ LOW: No accessibility audit performed",
      "❌ LOW: SendGrid API key presence logged (information disclosure)"
    ]
  },
  "recommendations_priority": [
    {
      "priority": 1,
      "title": "Implementare autenticazione e autorizzazione",
      "effort": "High",
      "impact": "Critical"
    },
    {
      "priority": 2,
      "title": "Configurare CORS con whitelist origini",
      "effort": "Low",
      "impact": "Critical"
    },
    {
      "priority": 3,
      "title": "Aggiungere Helmet per security headers",
      "effort": "Low",
      "impact": "High"
    },
    {
      "priority": 4,
      "title": "Implementare rate limiting",
      "effort": "Low",
      "impact": "High"
    },
    {
      "priority": 5,
      "title": "Hashare i token di conferma",
      "effort": "Medium",
      "impact": "High"
    }
  ]
}
