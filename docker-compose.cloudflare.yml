# ========================================
# Sphyra Wellness Lab - Cloudflare Tunnel
# HTTPS tramite Cloudflare - NESSUNA PORTA ESPOSTA
# ========================================

services:
  # ========================================
  # CLOUDFLARE TUNNEL (cloudflared)
  # ========================================
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: sphyra-cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - sphyra-network
    depends_on:
      - nginx

  # ========================================
  # NGINX - Reverse Proxy (Cloudflare SSL)
  # ========================================
  nginx:
    image: nginx:alpine
    container_name: sphyra-nginx
    restart: unless-stopped
    # NESSUNA PORTA ESPOSTA - traffico solo via Cloudflare Tunnel
    volumes:
      # Nginx configuration
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d/sphyra-cloudflare.conf:/etc/nginx/conf.d/default.conf:ro
      # Logs
      - nginx_logs:/var/log/nginx
    networks:
      - sphyra-network
    depends_on:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    environment:
      # Dominio per la configurazione Nginx
      - DOMAIN=${DOMAIN}
    command: >
      /bin/sh -c "envsubst '$${DOMAIN}' < /etc/nginx/conf.d/default.conf > /etc/nginx/conf.d/sphyra.conf
      && rm /etc/nginx/conf.d/default.conf
      && nginx -g 'daemon off;'"

  # ========================================
  # DATABASE - CouchDB (INTERNO)
  # ========================================
  couchdb:
    image: apache/couchdb:latest
    container_name: sphyra-couchdb
    restart: unless-stopped
    ports:
      # Expose CouchDB port for local development/configuration
      - "5984:5984"
    environment:
      - COUCHDB_USER=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
    volumes:
      - couchdb_data:/opt/couchdb/data
      - couchdb_config:/opt/couchdb/etc/local.d
    networks:
      - sphyra-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/_up"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    labels:
      - "traefik.enable=false"

  # ========================================
  # BACKEND - API Server (HTTPS)
  # ========================================
  backend:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: sphyra-backend
    restart: unless-stopped
    volumes:
      # Shared uploads directory
      - uploads_data:/app/server/uploads
    environment:
      - NODE_ENV=production
      - PORT=3001
      # JWT Secret for authentication
      - JWT_SECRET=${JWT_SECRET}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - SENDGRID_FROM_EMAIL=${SENDGRID_FROM_EMAIL:-noreply@sphyrawellness.com}
      - SENDGRID_FROM_NAME=${SENDGRID_FROM_NAME:-Sphyra Wellness Lab}
      # Frontend URL (HTTPS public domain via Cloudflare)
      - FRONTEND_URL=https://${DOMAIN}
      # CouchDB (internal)
      - COUCHDB_URL=http://couchdb:5984
      - COUCHDB_USERNAME=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      - REMINDER_SEND_HOUR=${REMINDER_SEND_HOUR:-10}
      - REMINDER_SEND_MINUTE=${REMINDER_SEND_MINUTE:-0}
      # CORS - Permetti il dominio pubblico
      - ALLOWED_ORIGINS=https://${DOMAIN}
    depends_on:
      couchdb:
        condition: service_healthy
    networks:
      - sphyra-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ========================================
  # FRONTEND - PWA (HTTPS)
  # ========================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.https
      args:
        - VITE_API_URL=/api
    container_name: sphyra-frontend
    restart: unless-stopped
    volumes:
      # Shared uploads directory (read-only for frontend)
      - uploads_data:/usr/share/nginx/html/uploads:ro
    depends_on:
      - backend
    networks:
      - sphyra-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ========================================
# NETWORKS
# ========================================
networks:
  sphyra-network:
    driver: bridge

# ========================================
# VOLUMES
# ========================================
volumes:
  couchdb_data:
    driver: local
  couchdb_config:
    driver: local
  nginx_logs:
    driver: local
  uploads_data:
    driver: local
